; validation.aifpl
; Project validation functions
;
; Includes:
; - Circular dependency detection
; - Data consistency checks
; - Task validation
; - Dependency validation

(letrec (         ; ============================================================================
         ; GRAPH OPERATIONS
         ; ============================================================================
         ; Get all predecessors of a task
(get-predecessors (lambda (task-id dependencies)
                             (map (lambda (dep)
                                (alist-get dep "from-task"))
                                  (filter (lambda (dep)
                                     (string=? (alist-get dep "to-task") task-id))
                                          dependencies))))
         ; Get all successors of a task


         (get-successors (lambda (task-id dependencies)
                           (map (lambda (dep)
                              (alist-get dep "to-task"))
                                (filter (lambda (dep)
                                   (string=? (alist-get dep "from-task") task-id))
                                        dependencies))))
         ; Check if a task exists in the project


         (task-exists? (lambda (task-id tasks)
                         (any? (lambda (task)
                            (string=? (alist-get task "id") task-id))
                               tasks)))
         ; ============================================================================
         ; CIRCULAR DEPENDENCY DETECTION
         ; ============================================================================
         ; Detect cycles using depth-first search
         ; Returns a list of cycles found (each cycle is a list of task IDs)


         (detect-cycles (lambda (tasks dependencies)
                          (letrec ((all-task-ids (map (lambda (t) (alist-get t "id")) tasks))

                                   (dfs-visit (lambda (task-id path visited-in-path)
                                                ; Check if we've seen this task in current path (cycle!)
                                                (if (member? task-id visited-in-path)
                                                  ; Found a cycle - extract the cycle from path
                                                  (let ((cycle-start-pos (position task-id path)))
                                                    (if (!= cycle-start-pos #f)
                                                      (list (drop cycle-start-pos (append path (list task-id))))
                                                      (list)))
                                                  ; Not a cycle yet, continue DFS
                                                  (let* ((successors (get-successors task-id dependencies))
                                                         (new-path (append path (list task-id)))
                                                         (new-visited (cons task-id visited-in-path)))
                                                    (fold append
                                                          (list)
                                                          (map (lambda (succ)
                                                             (dfs-visit succ new-path new-visited))
                                                               successors)))))))
                            ; Start DFS from each task
                            (fold append
                                  (list)
                                  (map (lambda (task-id)
                                     (dfs-visit task-id (list) (list)))
                                       all-task-ids)))))
         ; Return alist of all validation functions


         (alist (list "get-predecessors" get-predecessors))
         (list "get-successors")
         )
  get-successors)

(list "task-exists?" task-exists?)
(list "detect-cycles" detect-cycles)
(list "has-circular-dependencies?"
      has-circular-dependencies?)
(list "validate-task" validate-task)
(list "validate-dependency" validate-dependency)
(list "validate-project" validate-project)
(list "find-duplicate-task-ids" find-duplicate-task-ids)
(list "find-orphaned-tasks" find-orphaned-tasks)
(list "find-tasks-with-invalid-calendars"
      find-tasks-with-invalid-calendars)


